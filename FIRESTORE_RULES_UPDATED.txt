rules_version = '2';

service cloud.firestore {

  match /databases/{database}/documents {

    

    function isAuthenticated() {

      return request.auth != null;

    }

    

    function getUserData() {

      return get(/databases/$(database)/documents/Resergodb/$(request.auth.uid)).data;

    }

    

    function isHost() {

      return isAuthenticated() && 

             exists(/databases/$(database)/documents/Resergodb/$(request.auth.uid)) &&

             getUserData().UserType == 'host';

    }

    

    match /Resergodb/{userId} {

      allow read: if isAuthenticated();

      allow write: if isAuthenticated() && request.auth.uid == userId;

    }

    

    match /listings/{listingId} {

      allow read: if resource.data.isDraft == false || 

                     (isAuthenticated() && resource.data.hostId == request.auth.uid);

      allow create: if isHost() && 

                       request.resource.data.hostId == request.auth.uid;

      allow update: if (isHost() && 

                       resource.data.hostId == request.auth.uid &&

                       request.resource.data.hostId == request.auth.uid) ||

                     (isAuthenticated() && 

                       request.resource.data.hostId == resource.data.hostId &&

                       request.resource.data.title == resource.data.title &&

                       request.resource.data.rate == resource.data.rate &&

                       request.resource.data.isDraft == resource.data.isDraft);

      allow delete: if isHost() && 

                       resource.data.hostId == request.auth.uid;

    }

    

    match /reviews/{reviewId} {

      allow read: if isAuthenticated();

      allow create: if isAuthenticated() && 

                       request.resource.data.guestId == request.auth.uid;

      allow update: if isAuthenticated() && 

                       resource.data.guestId == request.auth.uid &&

                       request.resource.data.guestId == request.auth.uid;

      allow delete: if isAuthenticated() && 

                       resource.data.guestId == request.auth.uid;

    }

    

    match /favorites/{userId} {

      allow read: if isAuthenticated() && request.auth.uid == userId;

      allow create: if isAuthenticated() && request.auth.uid == userId;

      allow update: if isAuthenticated() && request.auth.uid == userId;

      allow delete: if isAuthenticated() && request.auth.uid == userId;

    }

    

    // Messages collection - UPDATED WITH DELETE PERMISSION

    match /messages/{messageId} {

      // Users can read messages where they are sender or receiver

      allow read: if isAuthenticated() && 

                     (resource.data.senderId == request.auth.uid || 

                      resource.data.receiverId == request.auth.uid);

      

      // Users can create messages where they are the sender

      allow create: if isAuthenticated() && 

                       request.resource.data.senderId == request.auth.uid &&

                       request.resource.data.receiverId != null &&

                       request.resource.data.message != null &&

                       request.resource.data.message is string &&

                       request.resource.data.message.size() > 0;

      

      // Users can update messages they received (to mark as read)

      allow update: if isAuthenticated() && 

                       resource.data.receiverId == request.auth.uid &&

                       request.resource.data.senderId == resource.data.senderId &&

                       request.resource.data.receiverId == resource.data.receiverId &&

                       request.resource.data.message == resource.data.message;

      

      // ✅ UPDATED: Users can delete messages where they are sender or receiver

      allow delete: if isAuthenticated() && 

                       (resource.data.senderId == request.auth.uid ||

                        resource.data.receiverId == request.auth.uid);

    }

    

    // Conversations collection - UPDATED WITH DELETE PERMISSION

    match /conversations/{conversationId} {

      // Users can read conversations where they are a participant

      allow read: if isAuthenticated() && 

                     (resource.data.participant1Id == request.auth.uid || 

                      resource.data.participant2Id == request.auth.uid);

      

      // Users can create conversations where they are a participant

      allow create: if isAuthenticated() && 

                       (request.resource.data.participant1Id == request.auth.uid || 

                        request.resource.data.participant2Id == request.auth.uid);

      

      // Users can update conversations where they are a participant

      allow update: if isAuthenticated() && 

                       (resource.data.participant1Id == request.auth.uid || 

                        resource.data.participant2Id == request.auth.uid) &&

                       request.resource.data.participant1Id == resource.data.participant1Id &&

                       request.resource.data.participant2Id == resource.data.participant2Id;

      

      // ✅ UPDATED: Users can delete conversations where they are a participant

      allow delete: if isAuthenticated() && 

                       (resource.data.participant1Id == request.auth.uid ||

                        resource.data.participant2Id == request.auth.uid);

    }

    

    // ✅ Wallets collection - UPDATED FOR BOOKING PAYMENTS

    match /wallets/{userId} {

      // Users can only read their own wallet

      allow read: if isAuthenticated() && request.auth.uid == userId;

      

      // Users can create their own wallet

      allow create: if isAuthenticated() && request.auth.uid == userId;

      

      // ✅ UPDATED: Allow any authenticated user to update wallets (for booking payments)

      // This allows hosts to update guest wallets when approving bookings

      // ⚠️ Note: This is less secure but allows booking payments to work

      // In production, use Cloud Functions for better security

      allow update: if isAuthenticated();

      

      // Users cannot delete their wallet

      allow delete: if false;

    }

    

    // ✅ Transactions collection - UPDATED FOR BOOKING PAYMENTS

    match /transactions/{transactionId} {

      // Users can only read their own transactions

      allow read: if isAuthenticated() && 

                     resource.data.userId == request.auth.uid;

      

      // ✅ UPDATED: Allow any authenticated user to create transactions (for booking payments)

      // This allows hosts to create transactions for guests when approving bookings

      // ⚠️ Note: This is less secure but allows booking payments to work

      allow create: if isAuthenticated();

      

      // Users can update their own transactions (for status updates)

      allow update: if isAuthenticated() && 

                       resource.data.userId == request.auth.uid &&

                       request.resource.data.userId == request.auth.uid;

      

      // Users cannot delete transactions (for transaction history)

      allow delete: if false;

    }

    

    // Coupons collection - for host discount coupons

    match /coupons/{couponId} {

      // Anyone authenticated can read coupons (for validation by guests)

      allow read: if isAuthenticated();

      

      // Only hosts can create their own coupons

      allow create: if isAuthenticated() && 

                       request.resource.data.hostId == request.auth.uid;

      

      // Only hosts can update their own coupons

      allow update: if isAuthenticated() && 

                       resource.data.hostId == request.auth.uid &&

                       request.resource.data.hostId == request.auth.uid;

      

      // Only hosts can delete their own coupons

      allow delete: if isAuthenticated() && 

                       resource.data.hostId == request.auth.uid;

    }

    

    // ✅ Bookings collection - SIMPLIFIED FOR BOOKING CREATION

    match /bookings/{bookingId} {

      // Users can read bookings where they are the guest or host

      allow read: if isAuthenticated() && 

                     (resource.data.guestId == request.auth.uid ||

                      resource.data.hostId == request.auth.uid);

      

      // ✅ SIMPLIFIED: Guests can create bookings where they are the guest

      // Removed unnecessary validations that might cause issues

      allow create: if isAuthenticated() && 

                       request.resource.data.guestId == request.auth.uid;

      

      // ✅ SIMPLIFIED: Allow hosts and guests to update bookings

      // Allow any authenticated user to update bookings

      // ⚠️ Note: This is less secure but allows booking approval to work

      // In production, use Cloud Functions for better security

      allow update: if isAuthenticated();

      

      // No delete allowed (for booking history)

      allow delete: if false;

    }

  }

}

